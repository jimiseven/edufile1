<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Excel con JavaScript</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <button onclick="generateExcel()">Generar Excel de Estudiantes</button>

    <script>
        function generateExcel() {
            fetch('obtenerDatos.php')
                .then(response => response.json())
                .then(data => {
                    const workbook = XLSX.utils.book_new();

                    // Estilos mejorados - Color de encabezado resaltado
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, size: 12, name: 'Calibri' },
                        fill: { fgColor: { rgb: "4472C4" } }, // Azul más fuerte y resaltado para encabezados
                        alignment: { horizontal: "center", vertical: "center", wrapText: true },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                    const headerCourseStyle = {
                        font: { bold: true, size: 18, name: 'Calibri', color: { rgb: "003366" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    const dataStyle = {
                        font: { name: 'Calibri', size: 11 },
                        alignment: { vertical: "center" },
                        border: {
                            top: { style: "thin", color: { rgb: "D4D4D4" } },
                            bottom: { style: "thin", color: { rgb: "D4D4D4" } },
                            left: { style: "thin", color: { rgb: "D4D4D4" } },
                            right: { style: "thin", color: { rgb: "D4D4D4" } }
                        }
                    };

                    // Estilo de tabla más moderno
                    const tableStyle = {
                        theme: "TableStyleMedium9",
                        showRowStripes: true,
                        showFirstColumn: false,
                        showLastColumn: false,
                        showColumnHeaders: true,
                        showTotalRow: false
                    };

                    // Mapeo de niveles a colores (opcional, si aún quieres colores de pestaña)
                    const levelColors = {
                        "PRIMARIA": "lightblue",
                        "SECUNDARIA": "lightgreen",
                        "INICIAL": "lightyellow",
                        "BACHILLERATO": "lightcoral"
                        // Agrega más niveles y colores según sea necesario
                    };

                    // Crear una hoja de cálculo para cada curso
                    for (const courseKey in data) {
                        if (data.hasOwnProperty(courseKey)) {
                            const courseData = data[courseKey];
                            const headers = ["Nombre Completo", "RUDE", "Nivel", "Grado", "Paralelo", "Estado"];
                            const formattedData = courseData.map(student => [
                                student.nombre_completo,
                                student.rude_number,
                                student.nivel,
                                student.grade,
                                student.parallel,
                                student.status
                            ]);

                            // Crear hoja de cálculo
                            const wsData = [
                                [{ v: courseKey, s: headerCourseStyle }],
                                headers.map(header => ({ v: header, s: headerStyle })), // Usa headerStyle para los encabezados de columna
                                ...formattedData.map(row => row.map(cell => ({ v: cell, s: dataStyle })))
                            ];
                            const worksheet = XLSX.utils.aoa_to_sheet(wsData);
                            const range = XLSX.utils.decode_range(worksheet['!ref']);

                            // Definir rango de la tabla
                            const tableDefinition = {
                                name: `Tabla_${courseKey.replace(/ /g, '_')}`,
                                ref: XLSX.utils.encode_range({ s: { r: 1, c: 0 }, e: range.e }),
                                headerRow: true,
                                tableStyles: tableStyle,
                            };

                            // Añadir definición de tabla y autofiltro
                            worksheet['!tables'] = [tableDefinition];
                            worksheet['!autofilter'] = { ref: tableDefinition.ref };

                            // Ajustar anchos de columna
                            const cols = [
                                { wch: 35 },
                                { wch: 15 },
                                { wch: 12 },
                                { wch: 8 },
                                { wch: 10 },
                                { wch: 20 }
                            ];
                            worksheet['!cols'] = cols;
                            worksheet['!rows'] = [{ hpx: 30 }, { hpx: 25 }];

                            // Establecer color de pestaña basado en el nivel (opcional)
                            const levelName = courseKey.split(' ')[0].toUpperCase();
                            const tabColor = levelColors[levelName] || "white";
                            worksheet.sheetProps = { tabColor: tabColor };

                            XLSX.utils.book_append_sheet(workbook, worksheet, courseKey);
                        }
                    }

                    // Descargar el archivo Excel
                    XLSX.writeFile(workbook, "ListaEstudiantes.xlsx");
                })
                .catch(error => {
                    console.error('Error al obtener los datos:', error);
                });
        }
    </script>
</body>
</html>
